# Overview

In RDKV, a bash script "dumpLogs.sh" was executed to collect the journal logs from every configured service and store the logs to the respective log files. The dumpLogs.sh script was managed by a systemd service "dump-log.service". RDKV had a systemd timer unit "dump-log.timer" which is configured to start "dump-log.service" for every 10 seconds to trigger dumpLogs.sh. For every 10 seconds, the execution of dumpLogs.sh consumes heavy CPU as it involves execution of journalctl, sed, awk. For each service configured in dumpLogs.sh , all these journalctl, sed, awk will run and store the journal logs to the respective log files. dumpLogs.sh has been growing as new services introduced in RDKV/RDKTV.

To reduce the CPU usage, few systemd logging methods were tried as part of POC RDK-33543 - [PoC] Optimize RDK Systemd log framework

1. systemd service level direct logging - This facility is introduced from systemd version v244+. This facility allows any service to log directly on the file(StandardOutput=file:<file_path>) just like on stdout, journal, socket. The drawback of this facility is, it doesn't add any prefix to the log statements as it is a direct write from service bypassing journal. 

2. socket + third party logger - With services redirecting the stdout to a socket, a third party logger ( s6-log, multilog, .. ) collect the data from socket and add necessary prefix to it and redirect to the respective log file. This way still doesn't help on structuring the log data as journal data looks like.

3. syslog-ng - With syslog-ng, there are couple of methods to read journal logs
- Enabling ForwardToSyslog in journald configuration. This method forward all the journal messages generated by systemd-journald to syslog socket. syslog-ng will be configured to read the journal from syslog socket. This way saves the local storage of journal in RAM but it has its own drawbacks like loss of logs,..
- Read journal messages from the locally stored journal file (/run/log/journal/). syslog-ng will be configured to read the journal messages from the stored journal file. This method is more reliable and it is currently being followed.

# Implementation Details

## What is systemd journal?
A system service called "systemd-journald" collects, stores logging data in a structured, indexed journals based on logging information that is received from different sources (kmsg, service stdout, sd_journal_print,..). These journals are either stored in local storage or it can be forwarded to syslog socket. The journal data cannot be read directly. A utility called "journalctl" which comes with systemd package can be used to query the systemd journal and display in readable format. 

## How syslog-ng works?
syslog-ng is a package which can filter log messages , restructure them and store it in the configured log paths. There are lot of ways to read log messages (from file, from journal, from socket, from network, ..). In RDKV, syslog-ng will read the logs from local journal storage. Based on the filter, syslog-ng stores the log data in the respective log path.

## syslog-ng filter:
In dumpLogs.sh, the script execute journalctl for every configured systemd service and redirect it to the respective log file. Similar to that, in syslog-ng , the filter is based on systemd service. Every journal message will have metadata information associated with it. Below is the example.

### Json-pretty format of a single journal log data:

```
{
        "__CURSOR" : "s=f037c31de3a54307b580543d336a2baf;i=1ecdb;b=911f8d67676d453c94ee1b6ba1eb613e;m=51a83ccda;t=5d32fa9952294;x=f5af8d23e675f7b1",
        "__REALTIME_TIMESTAMP" : "1639576545600148",
        "__MONOTONIC_TIMESTAMP" : "21919681754",
        "_BOOT_ID" : "911f8d67676d453c94ee1b6ba1eb613e",
        "_TRANSPORT" : "stdout",
        "PRIORITY" : "6",
        "SYSLOG_FACILITY" : "3",
        "_UID" : "0",
        "_GID" : "0",
        "_MACHINE_ID" : "1ad36c0cb7774b478f97d5bb80aa5053",
        "_HOSTNAME" : "arrisxg1v4",
        "_CAP_EFFECTIVE" : "3fffffffff",
        "_SYSTEMD_SLICE" : "system.slice",
        "_EXE" : "/bin/bash.bash",
        "SYSLOG_IDENTIFIER" : "startWPE",
        "_PID" : "4016",
        "_COMM" : "startWPE",
        "_CMDLINE" : "/bin/sh /lib/rdk/startWPE",
        "_SYSTEMD_CGROUP" : "/system.slice/wpeframework.service",
        "_SYSTEMD_UNIT" : "wpeframework.service",
        "MESSAGE" : "[4093] INFO [DeviceDiagnostics.cpp:132] getConfigurationWrapper: response={\"paramList\":[{\"name\":\"Device.X_RDKCENTRAL-COM_DocsIf.docsIfCmStatusTxPower\",\"value\":\"435\"},{\"name\":\"Device.X_RDKCENTRAL-COM_DocsIf.docsIfCmStatusT3Timeouts\",\"value\":\"1\"}],\"success\":true}"
}
```

For every log message generated by a process managed by a systemd service, the systemd-journald process will add the metainformation and store it as journal data. Each journal data will have these journal fields. 

Using these journal field(s), syslog-ng can filter the log data. 

Ex: With the above meta information, it is evident that the "MESSAGE" is generated from the process "startWPE" managed by systemd unit "wpeframework.service". Hence, the filter can be set to "_SYSTEMD_UNIT" or "_COMM" or "SYSLOG_IDENTIFIER".

It is better to set the filter to _SYSTEMD_UNIT  as it is easy to capture the logs from the particular service to the respective log path. 

Ex:

filter f_ocapri { "${.SDATA.journald._SYSTEMD_UNIT}" eq "runsnmp.service" or "${.SDATA.journald._SYSTEMD_UNIT}" eq "rmfstreamer.service" or "${.SDATA.journald._SYSTEMD_UNIT}" eq "runpod.service" or "${.SDATA.journald._SYSTEMD_UNIT}" eq "sdvagent.service" };

filter f_authservice { "${.SDATA.journald._SYSTEMD_UNIT}" eq "authservice.service" };

For more information on syslog-ng filter, please refer - https://www.syslog-ng.com/technical-documents/doc/syslog-ng-open-source-edition/3.24/administration-guide/57#TOPIC-1298086

## syslog-ng destination:
For every filter, a respective destination should be configured. In that case, if the log message matches the filter, it will be stored in the respective destination log path. If there is no destination configured for the filter, the log message will be dropped.

# Framework
For POC, a constant syslog-ng.conf was used. But it is not good to update the syslog-ng configuration file every time when a new systemd service (with journal logging) is introduced in RDK. This led to the development of a framework which generates the syslog-ng configuration file based on the variables defined in recipe files.

A new framework is developed to generate the syslog-ng configuration while building the image. The framework collect the following information from the recipe files.

- Filter name
- Systemd service name
- Respective log file name
- Log rate


# syslog-ng-config-gen.bbclass
A bbclass "syslog-ng-config-gen" is developed to generate filter files and metadata files by collecting data from recipes which inherited the bbclass.

- A couple of directories - "filter" and "metadata" will be created at '${D}${sysconfdir}/syslog-ng/'.
- Values of "SYSLOG-NG_FILTER" will be collected from the recipes (inherited the bbclass) and placed at '${D}${sysconfdir}/syslog-ng/filter/PN.filter'.
- PN corresponds to the package name (recipe) 
  - Ex: authservice.filter , sysint.filter , iarmbus.filter ,..
- For each filter, the corresponding service name, log path and log rate data will be collected from recipes. SYSLOG-NG_SERVICE_<filter> , SYSLOG-NG_DESTINATION_<filter> , SYSLOG-NG_LOGRATE_<filter>
- The collected data will be captured at '${D}${sysconfdir}/syslog-ng/filter/PN.metadata'. PN corresponds to the package name (recipe) 
  - Ex: iarmbus.metadata, sysint.metadata, ..


# syslog-ng-config.inc
Post roofs, the framework generates syslog-ng configuration file based on the filter and metadata files.

- A master filter file will be created and placed at ${IMAGE_ROOTFS}/${sysconfdir}/syslog-ng/filter/filter_file.conf. This master filter file will be created by collecting data from all the filter files present in rootfs.
- A master metadata file will be created and placed at ${IMAGE_ROOTFS}/${sysconfdir}/syslog-ng/metadata/metadata.conf. This master metadata file will be created by collecting data from all the metadata files present in rootfs.
- syslog-ng.conf file will be created at ${IMAGE_ROOTFS}/${sysconfdir}/syslog-ng/syslog-ng.conf. 
- All the constant data will be written on the syslog-ng.conf file by the framework.
  - ex: version, modules requires, sources, templates
- On the next step, filters will be updated in the conf file. This involves the filter name and the respective service name.
  - ex: filter f_trm { "${.SDATA.journald._SYSTEMD_UNIT}" eq "wsproxy.service" or "${.SDATA.journald._SYSTEMD_UNIT}" eq "trm-srv.service" };
- After filters, destinations will be updated based on SYSLOG-NG_DESTINATION_filter for every filter.
  - ex: destination d_trm { file("`log_path`/trm.log" template("$(t_rdk)\n"));};
- Finally, the log order will be updated. Based on the SYSLOG-NG_LOGRATE_filter, the log flow order with filter and destination will be added in the configuration file.
  - ex: log { source(s_journald); filter(f_trm); destination(d_trm); flags(final); };


# Developer guide for introducing new log file
It is very simple to add a new log file in RDKV via syslog-ng. In RDKV, journal messages of a systemd service will be stored in respective log file when configured. The developer should be very clear about the systemd service that logs to the new log file.

Following are the steps to add the new logging facility in RDKV.

1. Figure out the Yocto recipe from where the systemd service is installed. The details must be updated in the respective recipe.
2. Inherit the bbclass "syslog-ng-config-gen" in the recipe.
   - inherit syslog-ng-config-gen
3. Add the syslog-ng filter in the recipe. The filter is the name which must be used for the further configurations. For easy understanding, keep the service name as filter.
   - SYSLOG-NG_FILTER = "<service_name>"
4. In the recipe, add the systemd service name of whom the journal logs to be retrieved. If multiple services log to a same file, then mention the services name with a proper space.
   - SYSLOG-NG_SERVICE_filter = "systemd_service"
   - SYSLOG-NG_SERVICE_filter = "systemd_service systemd_service systemd_service"
5. Add the log file name as destination in the recipe. This destination will be mapped to the filter and logs form the mentioned systemd service will be redirected to this destination.
   - SYSLOG-NG_DESTINATION_filter = "log_file.extension"
6. As a last step, mention the log rate in the recipe. This is very important configuration which might affect the overall CPU performance of the device. The developer should be clear about the log rate of the systemd service.  
   - SYSLOG-NG_LOGRATE_filter = "log_rate"


## Log rates:
 - very-high
 - high
 - medium
 - low

**Generally syslog-ng process the log statements in the order they appear in the configuration file. Hence the log rate plays an important role. If the logs of systemd service with "very-high" logging rate are processed at the end , it will impact the performance.**

## Example configurations:

1. meta-rdk-video/recipes-extended/audiocapturemgr/audiocapturemgr_git.bb

- inherit syslog-ng-config-gen
- SYSLOG-NG_FILTER = "audiocapturemgr"
- SYSLOG-NG_SERVICE_audiocapturemgr = "audiocapturemgr.service"
- SYSLOG-NG_DESTINATION_audiocapturemgr = "audiocapturemgr.log"
- SYSLOG-NG_LOGRATE_audiocapturemgr = "medium"

2. meta-rdk-video/recipes-extended/iarmmgrs/iarmmgrs_git.bb

- inherit syslog-ng-config-gen
- SYSLOG-NG_FILTER = "uimgr"
- SYSLOG-NG_SERVICE_uimgr += "irmgr.service dsmgr.service pwrmgr.service mfrmgr.service sysmgr.service"
- SYSLOG-NG_DESTINATION_uimgr = "uimgr_log.txt"
- SYSLOG-NG_LOGRATE_uimgr = "very-high"

# Additional Notes

## Rewrite:

Rewrite rule allows us to modify the incoming messages from journal. 

Eg: Removal of pid from a log message

Below changes needs to be done in syslog-ng conf file

        conf.write("# Rewrite\n")
        conf.write("########################\n")
        conf.write("#Rewrite rule for removing PID\n")
        conf.write("rewrite r_pid { unset(value(PID)); };\n")


# Run time change of syslog-ng configuration file

## Adding a new log file:

syslog-ng configuration file exist at following paths in devices.

/etc/syslog-ng/syslog-ng.conf
/tmp/syslog-ng.conf


The file at "/etc/syslog-ng" is constant file and will be copied to "/tmp/syslog-ng.conf" at the start of syslog-ng.service. This is because of the requirement to change the syslog-ng.conf at runtime while the device going to light sleep in XG devices. While the device stay in LIGHTSLEEP, the logs will be stored at "/tmp/logs" instead of "/opt/logs". This is to avoid writing to disk for power saving. All the logs will be synced to "/opt/logs" for every 30 minutes. 

For a developer, to add a new log file at run time, follow the below steps.

1. Open the file "/tmp/syslog-ng.conf"
2. Add the filter at "Filters" section.
   - For service based filter, follow this template - filter f_\<filtername> { "${.SDATA.journald._SYSTEMD_UNIT}" eq "\<servicename.service>" };
   - For program based filter, follow this template - filter f_\<filtername> { "${PROGRAM}" eq "\<program>" };
3. Add the destination at "Destination" section.
   - destination d_\<destinationname> { file("<logpath/logfilename>" template("$(t_rdk)\n"));};  (Note - template t_rdk is created to follow the RDK logging format)
4. Add the log statement at "Logs" section. Log statements will  be processed in the order they appear in the configuration file. So based on the log rate of the service/program, the placement of log statement should be done.
   - log { source(s_journald); filter(f_\<filtername>); destination(d_\<destinationname>); flags(final); };
5. After adding filter, destination and log statement, save and exit the configuration file.
6. Execute "syslog-ng -s -f /tmp/syslog-ng.conf" to ensure the syntax. If there are any syntax errors, this can help before reloading/restarting the "syslog-ng".
   - Example : 
```
root@ciscoxid:~# syslog-ng -s -f /tmp/syslog-ng.conf
Error parsing config, syntax error, unexpected KW_FILTER, expecting ';' in /tmp/syslog-ng.conf:33:1-33:7:
28      # Filters
29      ########################
30      # With these rules, we can set which message go where.
31
32      filter f_mount_log { "${.SDATA.journald._SYSTEMD_UNIT}" eq "disk-check.service" or "${.SDATA.journald._SYSTEMD_UNIT}" eq "nvram.service" }
33----> filter f_authservice { "${.SDATA.journald._SYSTEMD_UNIT}" eq "authservice.service" };
33----> ^^^^^^
34      filter f_uimgr { "${.SDATA.journald._SYSTEMD_UNIT}" eq "irmgr.service" or "${.SDATA.journald._SYSTEMD_UNIT}" eq "dsmgr.service" or "${.SDATA.journald._SYSTEMD_UNIT}" eq "pwrmgr.service" or "${.SDATA.journald._SYSTEMD_UNIT}" eq "mfrmgr.service" or "${.SDATA.journald._SYSTEMD_UNIT}" eq "sysmgr.service" or "${.SDATA.journald._SYSTEMD_UNIT}" eq "deepsleepmgr.service" or "${.SDATA.journald._SYSTEMD_UNIT}" eq "iarmbusd.service" };
35      filter f_netsrvmgr { "${.SDATA.journald._SYSTEMD_UNIT}" eq "netsrvmgr.service" };
36      filter f_nlmon { "${.SDATA.journald._SYSTEMD_UNIT}" eq "nlmon.service" };
37      filter f_systemd { "${.SDATA.journald._SYSTEMD_UNIT}" eq "init.scope" };
38      filter f_dropbear { "${.SDATA.journald._SYSTEMD_UNIT}" eq "dropbear.service" };
```

7. After checking the syntax, reload the "syslog-ng" process to effect the recent changes. Execute "killall -HUP syslog-ng". This command will reload the syslog-ng configuration. 
8. Check the new log file and ensure the configured service/program logs are updated in it.


## Edit the existing log configuration:

To change the current configuration, follow the below steps.

1. Open the file "/tmp/syslog-ng.conf"
2. To modify the service/program name , edit the respective filter.
   - For service based filter, check for this template configuration - filter f_\<filtername> { "${.SDATA.journald._SYSTEMD_UNIT}" eq "<servicename.service>" };
   - For program based filter, check for this template configuration - filter f_\<filtername> { "${PROGRAM}" eq "\<program>" };
3. To modify destination , edit the respective destination.
   - destination d_\<destinationname> { file("<logpath/logfilename>" template("$(t_rdk)\n"));}; 
4. To remove, add, move the log statement, check for the respective log statement and update it.
   - log { source(s_journald); filter(f_\<filtername>); destination(d_\<destinationname>); flags(final); };
5. After adding filter, destination and log statement, save and exit the configuration file. Execute "syslog-ng -s -f /tmp/syslog-ng.conf" to ensure the syntax. If there are any syntax errors, this can help before reloading/restarting the "syslog-ng".
   - Example : 
```
root@ciscoxid:~# syslog-ng -s -f /tmp/syslog-ng.conf
Error parsing config, syntax error, unexpected KW_FILTER, expecting ';' in /tmp/syslog-ng.conf:33:1-33:7:
28      # Filters
29      ########################
30      # With these rules, we can set which message go where.
31
32      filter f_mount_log { "${.SDATA.journald._SYSTEMD_UNIT}" eq "disk-check.service" or "${.SDATA.journald._SYSTEMD_UNIT}" eq "nvram.service" }
33----> filter f_authservice { "${.SDATA.journald._SYSTEMD_UNIT}" eq "authservice.service" };
33----> ^^^^^^
34      filter f_uimgr { "${.SDATA.journald._SYSTEMD_UNIT}" eq "irmgr.service" or "${.SDATA.journald._SYSTEMD_UNIT}" eq "dsmgr.service" or "${.SDATA.journald._SYSTEMD_UNIT}" eq "pwrmgr.service" or "${.SDATA.journald._SYSTEMD_UNIT}" eq "mfrmgr.service" or "${.SDATA.journald._SYSTEMD_UNIT}" eq "sysmgr.service" or "${.SDATA.journald._SYSTEMD_UNIT}" eq "deepsleepmgr.service" or "${.SDATA.journald._SYSTEMD_UNIT}" eq "iarmbusd.service" };
35      filter f_netsrvmgr { "${.SDATA.journald._SYSTEMD_UNIT}" eq "netsrvmgr.service" };
36      filter f_nlmon { "${.SDATA.journald._SYSTEMD_UNIT}" eq "nlmon.service" };
37      filter f_systemd { "${.SDATA.journald._SYSTEMD_UNIT}" eq "init.scope" };
38      filter f_dropbear { "${.SDATA.journald._SYSTEMD_UNIT}" eq "dropbear.service" };
```
6. After checking the syntax, reload the "syslog-ng" process to effect the recent changes. Execute "killall -HUP syslog-ng". This command will reload the syslog-ng configuration. 
7. Check the modification in the log file and ensure.

# Journal storage

In RDKV, journal memory storage (in RAM) was

Current journal file storage (max) - 4 MB

Rotated journal file storage (max) - 4 MB

Number of rotation (max) -2 

Max size of journal storage - 8 MB


With syslog-ng , journal storage is reduced from 8 MB to 6 MB as there is no 10 seconds interval gap for reading logs from journal.

Current journal file storage (max) - 3 MB

Rotated journal file storage (max) - 3 MB

Number of rotation (max) -2 

Max size of journal storage - 6 MB



# stress-test and other optimizations of syslog-ng
Please refer DELIA-52915 - [RDK-33543] Optimize and Stress-test syslog-ng

# Confluence Page
For more details , refer https://etwiki.sys.comcast.net/x/CrvXNw
