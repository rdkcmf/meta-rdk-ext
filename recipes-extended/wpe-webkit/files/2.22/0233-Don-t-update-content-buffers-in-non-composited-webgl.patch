From 92f4012c5da71d19bcb7ed3673bdbeb6ceec786d Mon Sep 17 00:00:00 2001
From: Eugene Mutavchi <Ievgen_Mutavchi@comcast.com>
Date: Mon, 8 Feb 2021 15:49:17 +0000
Subject: [PATCH 4/4] Don't update content buffers in non composited webgl mode

---
 .../WebPage/CoordinatedGraphics/CompositingCoordinator.cpp   | 5 ++++-
 .../WebPage/CoordinatedGraphics/CompositingCoordinator.h     | 1 +
 2 files changed, 5 insertions(+), 1 deletion(-)

diff --git a/Source/WebKit/WebProcess/WebPage/CoordinatedGraphics/CompositingCoordinator.cpp b/Source/WebKit/WebProcess/WebPage/CoordinatedGraphics/CompositingCoordinator.cpp
index 5d010689b98b..46bf883e3ab3 100644
--- a/Source/WebKit/WebProcess/WebPage/CoordinatedGraphics/CompositingCoordinator.cpp
+++ b/Source/WebKit/WebProcess/WebPage/CoordinatedGraphics/CompositingCoordinator.cpp
@@ -39,6 +39,7 @@
 #include <WebCore/Page.h>
 #include <wtf/MemoryPressureHandler.h>
 #include <wtf/SetForScope.h>
+#include <WebCore/Settings.h>
 
 #if USE(GLIB_EVENT_LOOP)
 #include <wtf/glib/RunLoopSourcePriority.h>
@@ -51,6 +52,7 @@ CompositingCoordinator::CompositingCoordinator(Page* page, CompositingCoordinato
     : m_page(page)
     , m_client(client)
     , m_paintingEngine(Nicosia::PaintingEngine::create())
+    , m_nonCompositedWebGLEnabled(page->settings().nonCompositedWebGLEnabled())
 {
     m_nicosia.scene = Nicosia::Scene::create();
     m_state.nicosia.scene = m_nicosia.scene;
@@ -119,7 +121,8 @@ bool CompositingCoordinator::flushPendingLayerChanges()
     bool didSync = m_page->mainFrame().view()->flushCompositingStateIncludingSubframes();
 
     auto& coordinatedLayer = downcast<CoordinatedGraphicsLayer>(*m_rootLayer);
-    coordinatedLayer.updateContentBuffersIncludingSubLayers();
+    if (!m_nonCompositedWebGLEnabled)
+      coordinatedLayer.updateContentBuffersIncludingSubLayers();
     coordinatedLayer.syncPendingStateChangesIncludingSubLayers();
 
     flushPendingImageBackingChanges();
diff --git a/Source/WebKit/WebProcess/WebPage/CoordinatedGraphics/CompositingCoordinator.h b/Source/WebKit/WebProcess/WebPage/CoordinatedGraphics/CompositingCoordinator.h
index 4308eae2ff62..2a03a59d169d 100644
--- a/Source/WebKit/WebProcess/WebPage/CoordinatedGraphics/CompositingCoordinator.h
+++ b/Source/WebKit/WebProcess/WebPage/CoordinatedGraphics/CompositingCoordinator.h
@@ -145,6 +145,7 @@ private:
     bool m_isFlushingLayerChanges { false };
     bool m_shouldSyncFrame { false };
     bool m_didInitializeRootCompositingLayer { false };
+    bool m_nonCompositedWebGLEnabled { false };
 
     WebCore::FloatRect m_visibleContentsRect;
 
-- 
2.17.1

