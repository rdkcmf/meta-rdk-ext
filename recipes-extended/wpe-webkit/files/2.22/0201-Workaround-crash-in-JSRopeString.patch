From cf2a328a4a50bcf60966697fdc455dd4545c80f0 Mon Sep 17 00:00:00 2001
From: Eugene Mutavchi <Ievgen_Mutavchi@comcast.com>
Date: Fri, 14 Aug 2020 19:13:17 +0000
Subject: [PATCH] Workaround crash in JSRopeString
Source: COMCAST
License: LGPL-2.1-or-later
Upstream-Status: None
Signed-off-by: Eugene Mutavchi <Ievgen_Mutavchi@comcast.com>

---
 Source/JavaScriptCore/runtime/JSString.h | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/Source/JavaScriptCore/runtime/JSString.h b/Source/JavaScriptCore/runtime/JSString.h
index 7c7690947293..133d6f1cd025 100644
--- a/Source/JavaScriptCore/runtime/JSString.h
+++ b/Source/JavaScriptCore/runtime/JSString.h
@@ -123,7 +123,6 @@ private:
         Base::finishCreation(vm);
         setLength(length);
         setIs8Bit(m_value.impl()->is8Bit());
-        Heap::heap(this)->reportExtraMemoryAllocated(cost);
     }
 
 protected:
@@ -139,6 +138,7 @@ public:
     {
         unsigned length = value->length();
         size_t cost = value->cost();
+        vm.heap.reportExtraMemoryAllocated(cost);
         JSString* newString = new (NotNull, allocateCell<JSString>(vm.heap)) JSString(vm, WTFMove(value));
         newString->finishCreation(vm, length, cost);
         return newString;
-- 
2.24.0

