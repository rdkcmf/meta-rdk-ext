From: 8d8ac1aa1873a2086943bdf1169d886aea8bf5bf Mon Sep 17 00:00:00 2001
From: Ievgen Mutavchi <Ievgen_Mutavchi@comcast.com>
Date: Sun, 26 Apr 2020 11:48:00 -0400
Subject: [MSE] update `m_bufferFull` flag when evicted enough
Source: COMCAST
License: GPLV2
Upstream-Status: None
Signed-off-by: Eugene Mutavchi <Ievgen_Mutavchi@comcast.com>

---
 Source/WebCore/Modules/mediasource/SourceBuffer.cpp | 6 ++++++
 1 file changed, 6 insertions(+)

Index: git/Source/WebCore/Modules/mediasource/SourceBuffer.cpp
===================================================================
--- git.orig/Source/WebCore/Modules/mediasource/SourceBuffer.cpp
+++ git/Source/WebCore/Modules/mediasource/SourceBuffer.cpp
@@ -994,6 +994,12 @@ void SourceBuffer::evictCodedFrames(size
 
     if (MediaTime::zeroTime() != rangeStart && rangeStart < maximumRangeEnd) {
         removeCodedFrames(MediaTime::zeroTime(), rangeStart, true);
+        // Check if removed enough already
+        if (extraMemoryCost() + newDataSize < maximumBufferSize) {
+            LOG(MediaSource, "SourceBuffer::evictCodedFrames(%p) - the buffer is not full anymore.", this);
+            m_bufferFull = false;
+            return;
+        }
     }
 
     while (rangeStart < maximumRangeEnd) {
