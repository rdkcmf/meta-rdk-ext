From f3304c421c6a669609698ee96b6daa9e343900ad Mon Sep 17 00:00:00 2001
From: Siva Sankar Raja <sivasankar_raja@comcast.com>
Source: COMCAST
License: LICENSE-LGPL-2.1
Upstream-Status: Pending
Signed-off-by: Siva Sankar Raja <sivasankar_raja@comcast.com>
Date: Sat, 6 Jul 2019 16:36:48 +0000
Subject: [PATCH]  Shared JSC build

---
 Source/JavaScriptCore/PlatformWPE.cmake        | 11 ++++++++++
 Source/JavaScriptCore/wpe-javascriptcore.pc.in | 11 ++++++++++
 Source/WTF/wtf/RAMSize.cpp                     |  1 +
 Source/WebCore/PlatformWPE.cmake               |  1 +
 Source/WebKit/CMakeLists.txt                   |  2 ++
 Source/WebKit/PlatformWPE.cmake                | 29 ++++++++++++++++++++++++++
 Source/WebKit/wpe/wpe-webkit.pc.in             |  2 +-
 Source/cmake/OptionsWPE.cmake                  |  6 ++++++
 8 files changed, 62 insertions(+), 1 deletion(-)
 create mode 100644 Source/JavaScriptCore/wpe-javascriptcore.pc.in

diff --git a/Source/JavaScriptCore/PlatformWPE.cmake b/Source/JavaScriptCore/PlatformWPE.cmake
index 5df47559a59..447c3757643 100644
--- a/Source/JavaScriptCore/PlatformWPE.cmake
+++ b/Source/JavaScriptCore/PlatformWPE.cmake
@@ -1,7 +1,18 @@
 include(GLib.cmake)
 
+set(JavaScriptCore_OUTPUT_NAME WPEJavaScriptCore)
+
+if ("${JavaScriptCore_LIBRARY_TYPE}" MATCHES "SHARED")
+   add_definitions(-DSTATICALLY_LINKED_WITH_WTF)
+   configure_file(wpe-javascriptcore.pc.in ${CMAKE_BINARY_DIR}/Source/JavaScriptCore/wpe-javascriptcore.pc @ONLY)
+   install(FILES "${CMAKE_BINARY_DIR}/Source/JavaScriptCore/wpe-javascriptcore.pc"
+        DESTINATION "${LIB_INSTALL_DIR}/pkgconfig"
+   )
+endif()
+
 list(APPEND JavaScriptCore_LIBRARIES
     ${GLIB_LIBRARIES}
+    ${GLIB_GMODULE_LIBRARIES}
 )
 
 list(APPEND JavaScriptCore_SYSTEM_INCLUDE_DIRECTORIES
diff --git a/Source/JavaScriptCore/wpe-javascriptcore.pc.in b/Source/JavaScriptCore/wpe-javascriptcore.pc.in
new file mode 100644
index 00000000000..3458ce582b5
--- /dev/null
+++ b/Source/JavaScriptCore/wpe-javascriptcore.pc.in
@@ -0,0 +1,11 @@
+prefix=@CMAKE_INSTALL_PREFIX@
+exec_prefix=${prefix}
+libdir=@LIB_INSTALL_DIR@
+includedir=${prefix}/include
+
+Name: WPEJavaScriptCore
+Description: WPE version of the JavaScriptCore engine
+Version: @PROJECT_VERSION@
+Requires: glib-2.0 gmodule-2.0
+Libs: -L${libdir} -lWPEJavaScriptCore -ldl
+Cflags: -I${includedir}/wpe-@WPE_API_VERSION@ -I${includedir}/wpe-@WPE_API_VERSION@/WPE
diff --git a/Source/WTF/wtf/RAMSize.cpp b/Source/WTF/wtf/RAMSize.cpp
index fc1a5d505f1..a8d3e0fc004 100644
--- a/Source/WTF/wtf/RAMSize.cpp
+++ b/Source/WTF/wtf/RAMSize.cpp
@@ -32,6 +32,7 @@
 #if OS(WINDOWS)
 #include <windows.h>
 #elif defined(USE_SYSTEM_MALLOC) && USE_SYSTEM_MALLOC
+#include <wtf/text/WTFString.h>
 #if OS(UNIX)
 #include <sys/sysinfo.h>
 #endif // OS(UNIX)
diff --git a/Source/WebCore/PlatformWPE.cmake b/Source/WebCore/PlatformWPE.cmake
index b74a2e46dae..363184995f6 100644
--- a/Source/WebCore/PlatformWPE.cmake
+++ b/Source/WebCore/PlatformWPE.cmake
@@ -35,6 +35,7 @@ list(APPEND WebCore_INCLUDE_DIRECTORIES
     "${WEBCORE_DIR}/platform/mediastream/gstreamer"
     "${WEBCORE_DIR}/platform/network/soup"
     "${WEBCORE_DIR}/platform/text/icu"
+    "${BMALLOC_DIR}"
 )
 
 list(APPEND WebCore_USER_AGENT_STYLE_SHEETS
diff --git a/Source/WebKit/CMakeLists.txt b/Source/WebKit/CMakeLists.txt
index 77d74f3f425..6b42711d758 100644
--- a/Source/WebKit/CMakeLists.txt
+++ b/Source/WebKit/CMakeLists.txt
@@ -431,6 +431,8 @@ WEBKIT_FRAMEWORK(WebKit)
 add_dependencies(WebKit WebCore ${WEBKIT_EXTRA_DEPENDENCIES})
 ADD_WEBKIT_PREFIX_HEADER(WebKit)
 
+set_target_properties(WebKit PROPERTIES INTERFACE_LINK_LIBRARIES "")
+
 add_executable(WebProcess ${WebProcess_SOURCES})
 ADD_WEBKIT_PREFIX_HEADER(WebProcess)
 target_link_libraries(WebProcess ${WebProcess_LIBRARIES})
diff --git a/Source/WebKit/PlatformWPE.cmake b/Source/WebKit/PlatformWPE.cmake
index 2c79a4e6e44..10d30b658c1 100644
--- a/Source/WebKit/PlatformWPE.cmake
+++ b/Source/WebKit/PlatformWPE.cmake
@@ -10,6 +10,12 @@ file(MAKE_DIRECTORY ${FORWARDING_HEADERS_WPE_DIR})
 file(MAKE_DIRECTORY ${FORWARDING_HEADERS_WPE_EXTENSION_DIR})
 file(MAKE_DIRECTORY ${FORWARDING_HEADERS_WPE_DOM_DIR})
 
+if ("${JavaScriptCore_LIBRARY_TYPE}" MATCHES "SHARED")
+    set(WPE_PC_DEPENDENICES "wpe-javascriptcore")
+else()
+    set(WPE_PC_DEPENDENICES "")
+endif()
+
 configure_file(wpe/wpe-webkit.pc.in ${CMAKE_BINARY_DIR}/wpe-webkit-${WPE_API_VERSION}.pc @ONLY)
 configure_file(wpe/wpe-web-extension.pc.in ${CMAKE_BINARY_DIR}/wpe-web-extension-${WPE_API_VERSION}.pc @ONLY)
 configure_file(wpe/wpe-webkit-deprecated.pc.in ${CMAKE_BINARY_DIR}/wpe-webkit-deprecated-${WPE_API_VERSION}.pc @ONLY)
@@ -229,6 +235,9 @@ add_custom_command(
 )
 
 list(APPEND WebKit_INCLUDE_DIRECTORIES
+    "${CMAKE_SOURCE_DIR}/Source"
+    "${CMAKE_BINARY_DIR}"
+    "${PAL_DIR}"
     "${DERIVED_SOURCES_JAVASCRIPCOREWPE_DIR}"
     "${FORWARDING_HEADERS_DIR}"
     "${FORWARDING_HEADERS_DIR}/JavaScriptCore/"
@@ -238,10 +247,22 @@ list(APPEND WebKit_INCLUDE_DIRECTORIES
     "${FORWARDING_HEADERS_WPE_DOM_DIR}"
     "${DERIVED_SOURCES_DIR}"
     "${DERIVED_SOURCES_WPE_API_DIR}"
+    "${DERIVED_SOURCES_WEBCORE_DIR}"
+    "${BMALLOC_DIR}"
+    "${JAVASCRIPTCORE_DIR}"
+    "${JAVASCRIPTCORE_DIR}/API"
+    "${JAVASCRIPTCORE_DIR}/ForwardingHeaders"
+    "${JAVASCRIPTCORE_DIR}/heap"
+    "${JAVASCRIPTCORE_DIR}/runtime"
+    "${WEBCORE_DIR}/Modules/fetch"
+    "${WEBCORE_DIR}/dom"
+    "${WEBCORE_DIR}/loader"
+    "${WEBCORE_DIR}/platform"
     "${WEBCORE_DIR}/platform/graphics/cairo"
     "${WEBCORE_DIR}/platform/graphics/freetype"
     "${WEBCORE_DIR}/platform/graphics/opentype"
     "${WEBCORE_DIR}/platform/graphics/texmap/coordinated"
+    "${WEBCORE_DIR}/platform/network"
     "${WEBCORE_DIR}/platform/network/soup"
     "${WEBKIT_DIR}/NetworkProcess/CustomProtocols/soup"
     "${WEBKIT_DIR}/NetworkProcess/soup"
@@ -292,6 +313,7 @@ list(APPEND WebKit_SYSTEM_INCLUDE_DIRECTORIES
     ${HARFBUZZ_INCLUDE_DIRS}
     ${LIBSOUP_INCLUDE_DIRS}
     ${WPE_INCLUDE_DIRS}
+    "${LIBGCRYPT_INCLUDE_DIRS}"
 )
 
 list(APPEND WebKit_LIBRARIES
@@ -491,6 +513,13 @@ if (EXPORT_DEPRECATED_WEBKIT2_C_API)
     )
 endif()
 
+list(APPEND WebProcess_LIBRARIES
+    ${LIBGCRYPT_LIBRARIES}
+)
+list(APPEND NetworkProcess_LIBRARIES
+    ${LIBGCRYPT_LIBRARIES}
+)
+
 install(TARGETS WPEInjectedBundle
         DESTINATION "${LIB_INSTALL_DIR}/wpe-webkit-${WPE_API_VERSION}/injected-bundle"
 )
diff --git a/Source/WebKit/wpe/wpe-webkit.pc.in b/Source/WebKit/wpe/wpe-webkit.pc.in
index 4c66fdce508..8b17a193b70 100644
--- a/Source/WebKit/wpe/wpe-webkit.pc.in
+++ b/Source/WebKit/wpe/wpe-webkit.pc.in
@@ -7,6 +7,6 @@ Name: WPE WebKit
 Description: Embeddable Web content engine
 URL: https://wpewebkit.org
 Version: @PROJECT_VERSION@
-Requires: glib-2.0 libsoup-2.4
+Requires: glib-2.0 libsoup-2.4 @WPE_PC_DEPENDENICES@
 Libs: -L${libdir} -lWPEWebKit-@WPE_API_VERSION@
 Cflags: -I${includedir}/wpe-webkit-@WPE_API_VERSION@
diff --git a/Source/cmake/OptionsWPE.cmake b/Source/cmake/OptionsWPE.cmake
index 4999f3b3f06..5e6e7eb71f4 100644
--- a/Source/cmake/OptionsWPE.cmake
+++ b/Source/cmake/OptionsWPE.cmake
@@ -80,6 +80,12 @@ WEBKIT_OPTION_DEPEND(USE_EXTERNAL_HOLEPUNCH ENABLE_VIDEO)
 include(GStreamerDependencies)
 
 WEBKIT_OPTION_END()
+if (DEFINED ENABLE_SHARED_JSC AND ENABLE_SHARED_JSC)
+    set(JavaScriptCore_LIBRARY_TYPE SHARED)
+    add_definitions(-DUSE_EXPORT_MACROS=1)
+else()
+    set(JavaScriptCore_LIBRARY_TYPE STATIC)
+endif()
 
 find_package(Cairo 1.10.2 REQUIRED)
 find_package(Fontconfig 2.8.0 REQUIRED)
-- 
2.14.2

