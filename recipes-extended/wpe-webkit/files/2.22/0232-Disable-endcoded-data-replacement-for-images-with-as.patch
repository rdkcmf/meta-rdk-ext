From e192b60cf473f462e3c42321b6c8e947980b80aa Mon Sep 17 00:00:00 2001
From: Eugene Mutavchi <Ievgen_Mutavchi@comcast.com>
Date: Mon, 8 Feb 2021 15:47:48 +0000
Subject: [PATCH 3/4] Disable endcoded data replacement for images with async
 decoding

---
 Source/WebCore/loader/cache/CachedImage.cpp | 7 +++++++
 Source/WebCore/loader/cache/CachedImage.h   | 2 +-
 2 files changed, 8 insertions(+), 1 deletion(-)

diff --git a/Source/WebCore/loader/cache/CachedImage.cpp b/Source/WebCore/loader/cache/CachedImage.cpp
index 23761a603a78..c6129ee6ad16 100644
--- a/Source/WebCore/loader/cache/CachedImage.cpp
+++ b/Source/WebCore/loader/cache/CachedImage.cpp
@@ -674,4 +674,11 @@ CachedResource::RevalidationDecision CachedImage::makeRevalidationDecision(Cache
     return CachedResource::makeRevalidationDecision(cachePolicy);
 }
 
+bool CachedImage::mayTryReplaceEncodedData() const {
+    if (hasImage() && is<BitmapImage>(m_image.get())) {
+        return !downcast<BitmapImage>(m_image.get())->canUseAsyncDecodingForLargeImages();
+    }
+    return true;
+}
+
 } // namespace WebCore
diff --git a/Source/WebCore/loader/cache/CachedImage.h b/Source/WebCore/loader/cache/CachedImage.h
index 701851f987b8..71139a2faf17 100644
--- a/Source/WebCore/loader/cache/CachedImage.h
+++ b/Source/WebCore/loader/cache/CachedImage.h
@@ -108,7 +108,7 @@ private:
     void checkShouldPaintBrokenImage();
 
     void switchClientsToRevalidatedResource() final;
-    bool mayTryReplaceEncodedData() const final { return true; }
+    bool mayTryReplaceEncodedData() const final;
 
     void didAddClient(CachedResourceClient&) final;
     void didRemoveClient(CachedResourceClient&) final;
-- 
2.17.1

