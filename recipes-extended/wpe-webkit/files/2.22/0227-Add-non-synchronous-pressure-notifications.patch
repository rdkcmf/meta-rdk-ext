From 8e8ddbaca121b953eeece3c4a2f28580a6ef943e Mon Sep 17 00:00:00 2001
From: Eugene Mutavchi <Ievgen_Mutavchi@comcast.com>
Date: Fri, 5 Feb 2021 14:36:22 +0000
Subject: [PATCH 3/4] Add non-synchronous pressure notifications

---
 Source/WTF/wtf/MemoryPressureHandler.h            |  2 +-
 .../WTF/wtf/linux/MemoryPressureHandlerLinux.cpp  | 15 ++++++++-------
 Source/WebKit/Shared/ChildProcess.cpp             |  2 +-
 3 files changed, 9 insertions(+), 10 deletions(-)

diff --git a/Source/WTF/wtf/MemoryPressureHandler.h b/Source/WTF/wtf/MemoryPressureHandler.h
index 01ad7a718220..35f2e8d32164 100644
--- a/Source/WTF/wtf/MemoryPressureHandler.h
+++ b/Source/WTF/wtf/MemoryPressureHandler.h
@@ -71,7 +71,7 @@ public:
     WTF_EXPORT_PRIVATE void setShouldUsePeriodicMemoryMonitor(bool);
 
 #if OS(LINUX)
-    WTF_EXPORT_PRIVATE void triggerMemoryPressureEvent(bool isCritical);
+    WTF_EXPORT_PRIVATE void triggerMemoryPressureEvent(bool isCritical, bool isSynchronous);
 #endif
 
     void setMemoryKillCallback(WTF::Function<void()>&& function) { m_memoryKillCallback = WTFMove(function); }
diff --git a/Source/WTF/wtf/linux/MemoryPressureHandlerLinux.cpp b/Source/WTF/wtf/linux/MemoryPressureHandlerLinux.cpp
index bb499a7f1210..1252ec56203e 100644
--- a/Source/WTF/wtf/linux/MemoryPressureHandlerLinux.cpp
+++ b/Source/WTF/wtf/linux/MemoryPressureHandlerLinux.cpp
@@ -193,8 +193,9 @@ MemoryPressureHandler::MemoryUsagePoller::MemoryUsagePoller()
 
             if (vmRSS != static_cast<size_t>(-1) && vmRSS > s_pollMaximumProcessMemoryNonCriticalLimit) {
                 bool isCritical = vmRSS > s_pollMaximumProcessMemoryCriticalLimit;
-                callOnMainThread([isCritical] {
-                    MemoryPressureHandler::singleton().triggerMemoryPressureEvent(isCritical);
+                bool isSynchronous = vmRSS > s_pollMaximumProcessMemoryCriticalLimit * 1.05;
+                callOnMainThread([isCritical, isSynchronous] {
+                    MemoryPressureHandler::singleton().triggerMemoryPressureEvent(isCritical, isSynchronous);
                 });
                 return;
             }
@@ -214,21 +215,21 @@ MemoryPressureHandler::MemoryUsagePoller::~MemoryUsagePoller()
 
 
 
-void MemoryPressureHandler::triggerMemoryPressureEvent(bool isCritical)
+void MemoryPressureHandler::triggerMemoryPressureEvent(bool isCritical, bool isSynchronous)
 {
     if (!m_installed)
         return;
 
     if (ReliefLogger::loggingEnabled())
-        LOG(MemoryPressure, "Got memory pressure notification (%s)", isCritical ? "critical" : "non-critical");
+        LOG(MemoryPressure, "Got memory pressure notification (%s, %s) ", isCritical ? "critical" : "non-critical", isSynchronous ? "synchronous" : "non-synchronous");
 
     setUnderMemoryPressure(true);
 
     if (isMainThread())
-        respondToMemoryPressure(isCritical ? Critical::Yes : Critical::No, isCritical ? Synchronous::Yes : Synchronous::No);
+        respondToMemoryPressure(isCritical ? Critical::Yes : Critical::No, isSynchronous ? Synchronous::Yes : Synchronous::No);
     else
-        RunLoop::main().dispatch([this, isCritical] {
-            respondToMemoryPressure(isCritical ? Critical::Yes : Critical::No, isCritical ? Synchronous::Yes : Synchronous::No);
+        RunLoop::main().dispatch([this, isCritical, isSynchronous] {
+            respondToMemoryPressure(isCritical ? Critical::Yes : Critical::No, isSynchronous ? Synchronous::Yes : Synchronous::No);
         });
 
     if (ReliefLogger::loggingEnabled() && isUnderMemoryPressure())
diff --git a/Source/WebKit/Shared/ChildProcess.cpp b/Source/WebKit/Shared/ChildProcess.cpp
index 373f003c13c4..84a7805348aa 100644
--- a/Source/WebKit/Shared/ChildProcess.cpp
+++ b/Source/WebKit/Shared/ChildProcess.cpp
@@ -245,7 +245,7 @@ void ChildProcess::didReceiveInvalidMessage(IPC::Connection&, IPC::StringReferen
 #if OS(LINUX)
 void ChildProcess::didReceiveMemoryPressureEvent(bool isCritical)
 {
-    MemoryPressureHandler::singleton().triggerMemoryPressureEvent(isCritical);
+    MemoryPressureHandler::singleton().triggerMemoryPressureEvent(isCritical, isCritical);
 }
 #endif
 
-- 
2.17.1

