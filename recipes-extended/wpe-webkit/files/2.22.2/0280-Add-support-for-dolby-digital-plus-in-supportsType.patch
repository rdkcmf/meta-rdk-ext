From a2d23d95f54da973ab0f6a9dcf6ae733bdb02ebc Mon Sep 17 00:00:00 2001
From: Pawel Lampe <pawel.lampe@sky.uk>
Date: Wed, 25 Aug 2021 10:21:16 +0000
Subject: [PATCH] Add support for dolby digital plus in supportsType

---
 .../gstreamer/mse/MediaPlayerPrivateGStreamerMSE.cpp   | 18 ++++++++++++++++--
 .../gstreamer/mse/MediaPlayerPrivateGStreamerMSE.h     |  1 +
 2 files changed, 17 insertions(+), 2 deletions(-)

diff --git a/Source/WebCore/platform/graphics/gstreamer/mse/MediaPlayerPrivateGStreamerMSE.cpp b/Source/WebCore/platform/graphics/gstreamer/mse/MediaPlayerPrivateGStreamerMSE.cpp
index 8b7db92..67b37e3 100644
--- a/Source/WebCore/platform/graphics/gstreamer/mse/MediaPlayerPrivateGStreamerMSE.cpp
+++ b/Source/WebCore/platform/graphics/gstreamer/mse/MediaPlayerPrivateGStreamerMSE.cpp
@@ -1134,8 +1134,12 @@ MediaPlayer::SupportsType MediaPlayerPrivateGStreamerMSE::supportsType(const Med
     GST_DEBUG("supportsType() %s", parameters.type.raw().utf8().data());
 
     bool ok;
-    unsigned channels = parameters.type.parameter("channels"_s).toUInt(&ok);
-    if (ok && channels > MEDIA_MAX_AAC_CHANNELS)
+    int channels = parameters.type.parameter("channels"_s).toInt(&ok);
+    if (ok && (channels > MEDIA_MAX_AAC_CHANNELS || channels <= 0))
+        return result;
+
+    String features = parameters.type.parameter("features"_s);
+    if (!features.isEmpty() && !supportsFeatures(features))
         return result;
 
     float width = parameters.type.parameter("width"_s).toFloat(&ok);
@@ -1194,6 +1198,16 @@ MediaPlayer::SupportsType MediaPlayerPrivateGStreamerMSE::supportsType(const Med
     return extendedSupportsType(parameters, result);
 }
 
+bool MediaPlayerPrivateGStreamerMSE::supportsFeatures(const String& features)
+{
+    // Apple TV requires this one for DD+
+    constexpr auto dolbyDigitalPlusJOC = "joc";
+    if (features == dolbyDigitalPlusJOC)
+        return true;
+
+    return false;
+}
+
 void MediaPlayerPrivateGStreamerMSE::markEndOfStream(MediaSourcePrivate::EndOfStreamStatus status)
 {
     if (status != MediaSourcePrivate::EosNoError)
diff --git a/Source/WebCore/platform/graphics/gstreamer/mse/MediaPlayerPrivateGStreamerMSE.h b/Source/WebCore/platform/graphics/gstreamer/mse/MediaPlayerPrivateGStreamerMSE.h
index 08c2d42..a269ae2 100644
--- a/Source/WebCore/platform/graphics/gstreamer/mse/MediaPlayerPrivateGStreamerMSE.h
+++ b/Source/WebCore/platform/graphics/gstreamer/mse/MediaPlayerPrivateGStreamerMSE.h
@@ -105,6 +105,7 @@ public:
 private:
     static void getSupportedTypes(HashSet<String, ASCIICaseInsensitiveHash>&);
     static MediaPlayer::SupportsType supportsType(const MediaEngineSupportParameters&);
+    static bool supportsFeatures(const String&);
     static bool initializeGStreamer();
     static void ensureWebKitGStreamerElements();
     static HashSet<String, ASCIICaseInsensitiveHash>& mimeTypeCache();
-- 
1.9.1

