From eed322ea423a8f132d75807a8e0180643216c59c Mon Sep 17 00:00:00 2001
From: Sandeep Nair <sandeepnair@tataelxsi.co.in>
Date: Thu, 5 Feb 2015 02:24:33 -0500
Subject: [PATCH 9/9] BPV-8919 : Adding the fixes in dibbler for fixing the
 segmentation faults Reason for change: Dibbler causing segmentation fault in
 master Test Procedure: Provision box in ipv6 mode and start dibbler client
 Risks: Low

Change-Id: I1587a03d5c40a6c7b84986a263627df4fa63dba9
Signed-off-by: Sandeep Nair <sandeepnair@tataelxsi.co.in>
---
 Port-linux/lowlevel-options-linux.c | 26 ++++++++++++++++++++------
 1 file changed, 20 insertions(+), 6 deletions(-)

diff --git a/Port-linux/lowlevel-options-linux.c b/Port-linux/lowlevel-options-linux.c
index c79fdbf..70e5739 100644
--- a/Port-linux/lowlevel-options-linux.c
+++ b/Port-linux/lowlevel-options-linux.c
@@ -479,13 +479,18 @@ int prefix_add(const char* ifname, int ifindex, const char* prefixPlain, int pre
     if (!f) {
 	/* unable to open, so this file is missing, let's create it */
 	f = fopen(RADVD_FILE, "w");
-	fprintf(f, "#\n");
-	fprintf(f, "# Router Advertisement config file generated by Dibbler %s\n", DIBBLER_VERSION);
-	fprintf(f, "#\n");
-	fprintf(f, "\n");
+	if (!f) {
+		sprintf(errorMsg, "Unable to create %s file. \n", RADVD_FILE);
+	}
+	else {
+		fprintf(f, "#\n");
+		fprintf(f, "# Router Advertisement config file generated by Dibbler %s\n", DIBBLER_VERSION);
+		fprintf(f, "#\n");
+		fprintf(f, "\n");
+	}	
     }
     if (!f) {
-	sprintf(errorMsg, "Unable to open %s file.", RADVD_FILE);
+	sprintf(errorMsg, "Unable to open %s file.\n", RADVD_FILE);
 	return LOWLEVEL_ERROR_FILE;
     }
     fseek(f, 0, SEEK_END);
@@ -535,14 +540,23 @@ int prefix_del(const char* ifname, int ifindex, const char* prefixPlain, int pre
     FILE *f, *f2;
     struct stat st;
     int found = 0;
+    char * errorMsg = error_message();
 
     memset(&st,0,sizeof(st));
     stat(RADVD_FILE, &st);
     unlink(RADVD_FILE".old");
     rename(RADVD_FILE,RADVD_FILE".old");
-
+    
     f = fopen(RADVD_FILE".old","r");
+    if (!f) {
+	sprintf(errorMsg, "Unable to open %s file. \n", RADVD_FILE".old");
+	return LOWLEVEL_ERROR_FILE;
+    }
     f2 = fopen(RADVD_FILE,"w"); 
+    if (!f2) {
+	sprintf(errorMsg, "Unable to open %s file. \n", RADVD_FILE);
+	return LOWLEVEL_ERROR_FILE;
+    }
 
     snprintf(buf2, 511, "### %s start ###\n", ifname);
     while (fgets(buf,511,f)) {
-- 
2.3.1

